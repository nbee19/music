<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.2) 0%, transparent 50%);
        }

        .player-container {
            width: 100%;
            max-width: 420px;
            height: 90vh;
            max-height: 900px;
            background: var(--surface);
            border-radius: 24px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Header */
        .header {
            padding: 20px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Visualizer Section */
        .visualizer-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        #visualizer {
            width: 100%;
            height: 120px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        /* Enhanced Album Art with Vinyl Effect */
        .album-art-container {
            position: relative;
            margin-bottom: 30px;
            perspective: 1000px;
        }

        .album-art {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            position: relative;
            background: 
                radial-gradient(circle at center, 
                    transparent 28%, 
                    #1a1a1a 28%, 
                    #1a1a1a 29%, 
                    transparent 29%, 
                    transparent 31%, 
                    #1a1a1a 31%, 
                    #1a1a1a 32%, 
                    transparent 32%, 
                    transparent 34%, 
                    #1a1a1a 34%, 
                    #1a1a1a 35%, 
                    transparent 35%, 
                    transparent 37%, 
                    #1a1a1a 37%, 
                    #1a1a1a 38%, 
                    transparent 38%, 
                    transparent 40%, 
                    #1a1a1a 40%, 
                    #1a1a1a 41%, 
                    transparent 41%, 
                    transparent 43%, 
                    #1a1a1a 43%, 
                    #1a1a1a 44%, 
                    transparent 44%, 
                    transparent 46%, 
                    #1a1a1a 46%, 
                    #1a1a1a 47%, 
                    transparent 47%, 
                    transparent 49%, 
                    #1a1a1a 49%, 
                    #1a1a1a 50%, 
                    transparent 50%, 
                    transparent 52%, 
                    #1a1a1a 52%, 
                    #1a1a1a 53%, 
                    transparent 53%, 
                    transparent 55%, 
                    #1a1a1a 55%, 
                    #1a1a1a 56%, 
                    transparent 56%, 
                    transparent 58%, 
                    #1a1a1a 58%, 
                    #1a1a1a 59%, 
                    transparent 59%, 
                    transparent 61%, 
                    #1a1a1a 61%, 
                    #1a1a1a 62%, 
                    transparent 62%, 
                    transparent 64%, 
                    #1a1a1a 64%, 
                    #1a1a1a 65%, 
                    transparent 65%, 
                    transparent 67%, 
                    #1a1a1a 67%, 
                    #1a1a1a 68%, 
                    transparent 68%, 
                    transparent 70%, 
                    #1a1a1a 70%, 
                    #1a1a1a 71%, 
                    transparent 71%, 
                    transparent 73%, 
                    #1a1a1a 73%, 
                    #1a1a1a 74%, 
                    transparent 74%, 
                    transparent 76%, 
                    #1a1a1a 76%, 
                    #1a1a1a 77%, 
                    transparent 77%, 
                    transparent 79%, 
                    #1a1a1a 79%, 
                    #1a1a1a 80%, 
                    transparent 80%, 
                    transparent 82%, 
                    #1a1a1a 82%, 
                    #1a1a1a 83%, 
                    transparent 83%, 
                    transparent 85%, 
                    #1a1a1a 85%, 
                    #1a1a1a 86%, 
                    transparent 86%, 
                    transparent 88%, 
                    #1a1a1a 88%, 
                    #1a1a1a 89%, 
                    transparent 89%, 
                    transparent 91%, 
                    #1a1a1a 91%, 
                    #1a1a1a 92%, 
                    transparent 92%, 
                    transparent 94%, 
                    #1a1a1a 94%, 
                    #1a1a1a 95%, 
                    transparent 95%, 
                    transparent 97%, 
                    #1a1a1a 97%, 
                    #1a1a1a 98%, 
                    transparent 98%
                ),
                linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            box-shadow: 
                0 0 0 2px #0a0a0a,
                0 0 0 4px #1a1a1a,
                0 20px 40px rgba(0, 0, 0, 0.5),
                0 0 60px rgba(99, 102, 241, 0.2),
                inset 0 0 20px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }

        .album-art::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: radial-gradient(circle, #8b0000 0%, #660000 50%, #440000 100%);
            border-radius: 50%;
            box-shadow: 
                inset 0 0 10px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .album-art::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #000;
            border-radius: 50%;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.8);
            z-index: 3;
        }

        .album-art.playing {
            animation: rotateVinyl 4s linear infinite;
            box-shadow: 
                0 0 0 2px #0a0a0a,
                0 0 0 4px #1a1a1a,
                0 25px 50px rgba(0, 0, 0, 0.6),
                0 0 80px rgba(99, 102, 241, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        @keyframes rotateVinyl {
            from { 
                transform: rotate(0deg) translateZ(0);
            }
            to { 
                transform: rotate(360deg) translateZ(0);
            }
        }

        .vinyl-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #8b0000 0%, #660000 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            z-index: 2;
            box-shadow: 
                inset 0 0 15px rgba(0, 0, 0, 0.6),
                0 0 10px rgba(0, 0, 0, 0.4);
        }

        .vinyl-grooves {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: 
                repeating-radial-gradient(circle at center, 
                    transparent 0px, 
                    transparent 2px, 
                    rgba(255, 255, 255, 0.02) 2px, 
                    rgba(255, 255, 255, 0.02) 2.5px
                );
            pointer-events: none;
        }

        /* Song Info */
        .song-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .song-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .song-artist {
            font-size: 16px;
            color: var(--text-muted);
        }

        .favorite-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .favorite-btn.active {
            color: var(--error);
            transform: scale(1.2);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.play-pause {
            width: 70px;
            height: 70px;
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .control-btn.play-pause:hover {
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
        }

        /* Volume Control */
        .volume-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .volume-icon {
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.3s ease;
            width: 30px;
            text-align: center;
        }

        .volume-icon:hover {
            color: var(--text);
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .volume-level {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 3px;
            width: 70%;
            transition: width 0.1s ease;
            position: relative;
        }

        .volume-level::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Playlist Section */
        .playlist-section {
            background: var(--surface);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .playlist-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface-light);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .playlist-count {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: normal;
        }

        .playlist-actions {
            display: flex;
            gap: 10px;
        }

        .playlist-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .playlist {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .playlist-item {
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-item.active {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .playlist-item-info {
            flex: 1;
        }

        .playlist-item-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 12px;
            color: var(--text-muted);
        }

        .playlist-item-duration {
            font-size: 12px;
            color: var(--text-muted);
        }

        .playlist-item-actions {
            display: flex;
            gap: 8px;
        }

        .playlist-item-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            transition: color 0.3s ease;
        }

        .playlist-item-btn:hover {
            color: var(--text);
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* File Input */
        .file-input {
            display: none;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.success .notification-icon {
            color: var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.error .notification-icon {
            color: var(--error);
        }

        /* Scrollbar */
        .playlist::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .player-container {
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="header">
            <h1>Perfect Player</h1>
            <button class="settings-btn">⚙️</button>
        </div>

        <div class="visualizer-section">
            <canvas id="visualizer"></canvas>
            
            <div class="album-art-container">
                <div class="album-art" id="albumArt">
                    <div class="vinyl-grooves"></div>
                    <div class="vinyl-label">♪</div>
                </div>
            </div>

            <div class="song-info">
                <div class="song-title">
                    <span id="songTitle">No song selected</span>
                    <button class="favorite-btn" id="favoriteBtn">♡</button>
                </div>
                <div class="song-artist" id="songArtist">Add a song to start playing</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" id="shuffleBtn" title="Shuffle">🔀</button>
                <button class="control-btn" id="prevBtn">⏮</button>
                <button class="control-btn play-pause" id="playPauseBtn">▶</button>
                <button class="control-btn" id="nextBtn">⏭</button>
                <button class="control-btn" id="repeatBtn" title="Repeat">🔁</button>
            </div>

            <div class="volume-container">
                <span class="volume-icon" id="volumeIcon">🔊</span>
                <div class="volume-slider" id="volumeSlider">
                    <div class="volume-level" id="volumeLevel"></div>
                </div>
            </div>
        </div>

        <div class="playlist-section">
            <div class="playlist-header">
                <div class="playlist-title">
                    Playlist
                    <span class="playlist-count" id="playlistCount">(0)</span>
                </div>
                <div class="playlist-actions">
                    <button class="playlist-btn" id="clearBtn">Clear</button>
                    <button class="playlist-btn" id="addSongBtn">Add Song</button>
                </div>
            </div>
            <div class="playlist" id="playlist">
                <div class="empty-state">
                    <div class="empty-state-icon">🎵</div>
                    <div>Your playlist is empty</div>
                    <div style="font-size: 13px; margin-top: 8px;">Add some songs to get started</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" class="file-input" id="fileInput" accept="audio/*" multiple>

    <div class="notification" id="notification">
        <span class="notification-icon"></span>
        <span class="notification-text"></span>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        class PerfectMusicPlayer {
            constructor() {
                this.audio = document.getElementById('audioPlayer');
                this.playlist = [];
                this.currentSongIndex = -1;
                this.isPlaying = false;
                this.isShuffled = false;
                this.repeatMode = 0; // 0: off, 1: repeat all, 2: repeat one
                this.favorites = new Set();
                this.audioContext = null;
                this.analyser = null;
                this.source = null;
                this.animationId = null;
                this.previousVolume = 0.7; // Initialize previous volume

                this.initializeElements();
                this.setupEventListeners();
                this.setupVisualizer();
                this.loadFromLocalStorage();
                this.initializeVolume();
            }

            initializeElements() {
                this.albumArt = document.getElementById('albumArt');
                this.songTitle = document.getElementById('songTitle');
                this.songArtist = document.getElementById('songArtist');
                this.favoriteBtn = document.getElementById('favoriteBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progress = document.getElementById('progress');
                this.currentTimeEl = document.getElementById('currentTime');
                this.durationEl = document.getElementById('duration');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.shuffleBtn = document.getElementById('shuffleBtn');
                this.repeatBtn = document.getElementById('repeatBtn');
                this.volumeIcon = document.getElementById('volumeIcon');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.volumeLevel = document.getElementById('volumeLevel');
                this.playlistEl = document.getElementById('playlist');
                this.playlistCount = document.getElementById('playlistCount');
                this.addSongBtn = document.getElementById('addSongBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.fileInput = document.getElementById('fileInput');
                this.canvas = document.getElementById('visualizer');
                this.ctx = this.canvas.getContext('2d');
                this.notification = document.getElementById('notification');
            }

            initializeVolume() {
                // Set initial volume
                this.audio.volume = this.previousVolume;
                this.volumeLevel.style.width = `${this.previousVolume * 100}%`;
                this.updateVolumeIcon(this.previousVolume);
            }

            setupEventListeners() {
                // Playback controls
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.prevBtn.addEventListener('click', () => this.playPrevious());
                this.nextBtn.addEventListener('click', () => this.playNext());
                this.shuffleBtn.addEventListener('click', () => this.toggleShuffle());
                this.repeatBtn.addEventListener('click', () => this.toggleRepeat());
                
                // Progress bar
                this.progressBar.addEventListener('click', (e) => {
                    const rect = this.progressBar.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    this.audio.currentTime = percent * this.audio.duration;
                });

                // Volume control
                this.volumeSlider.addEventListener('click', (e) => {
                    const rect = this.volumeSlider.getBoundingClientRect();
                    const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                    this.setVolume(percent);
                });

                this.volumeIcon.addEventListener('click', () => {
                    this.toggleMute();
                });

                // Playlist
                this.addSongBtn.addEventListener('click', () => this.fileInput.click());
                this.clearBtn.addEventListener('click', () => this.clearPlaylist());
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                
                // Favorite
                this.favoriteBtn.addEventListener('click', () => this.toggleFavorite());

                // Audio events
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                this.audio.addEventListener('ended', () => this.handleSongEnd());
                this.audio.addEventListener('error', () => this.showNotification('Error loading audio file', 'error'));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.togglePlayPause();
                    } else if (e.code === 'ArrowLeft') {
                        this.audio.currentTime = Math.max(0, this.audio.currentTime - 5);
                    } else if (e.code === 'ArrowRight') {
                        this.audio.currentTime = Math.min(this.audio.duration, this.audio.currentTime + 5);
                    }
                });
            }

            setupVisualizer() {
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = this.canvas.offsetHeight;
            }

            setVolume(volume) {
                this.audio.volume = volume;
                this.volumeLevel.style.width = `${volume * 100}%`;
                this.updateVolumeIcon(volume);
                
                // Store previous volume if not muted
                if (volume > 0) {
                    this.previousVolume = volume;
                }
                
                this.saveToLocalStorage();
            }

            toggleMute() {
                if (this.audio.volume > 0) {
                    // Store current volume before muting
                    this.previousVolume = this.audio.volume;
                    this.setVolume(0);
                } else {
                    // Restore previous volume
                    this.setVolume(this.previousVolume);
                }
            }

            updateVolumeIcon(volume) {
                if (volume === 0) {
                    this.volumeIcon.textContent = '🔇';
                } else if (volume < 0.5) {
                    this.volumeIcon.textContent = '🔉';
                } else {
                    this.volumeIcon.textContent = '🔊';
                }
            }

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                let addedCount = 0;

                files.forEach(file => {
                    if (file.type.startsWith('audio/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const song = {
                                id: Date.now() + Math.random(),
                                name: file.name.replace(/\.[^/.]+$/, ""),
                                url: e.target.result,
                                file: file,
                                duration: 0
                            };
                            
                            // Get duration
                            const tempAudio = new Audio(song.url);
                            tempAudio.addEventListener('loadedmetadata', () => {
                                song.duration = tempAudio.duration;
                                this.playlist.push(song);
                                this.updatePlaylist();
                                this.saveToLocalStorage();
                                addedCount++;
                                
                                if (addedCount === files.filter(f => f.type.startsWith('audio/')).length) {
                                    this.showNotification(`Added ${addedCount} song${addedCount > 1 ? 's' : ''} to playlist`, 'success');
                                }
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            updatePlaylist() {
                this.playlistCount.textContent = `(${this.playlist.length})`;
                
                if (this.playlist.length === 0) {
                    this.playlistEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🎵</div>
                            <div>Your playlist is empty</div>
                            <div style="font-size: 13px; margin-top: 8px;">Add some songs to get started</div>
                        </div>
                    `;
                    return;
                }

                this.playlistEl.innerHTML = this.playlist.map((song, index) => `
                    <div class="playlist-item ${index === this.currentSongIndex ? 'active' : ''}" 
                         onclick="player.loadSong(${index})">
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.name}</div>
                            <div class="playlist-item-artist">Local file • ${this.formatTime(song.duration)}</div>
                        </div>
                        <div class="playlist-item-actions">
                            <button class="playlist-item-btn" onclick="event.stopPropagation(); player.removeSong(${index})" title="Remove">✕</button>
                        </div>
                    </div>
                `).join('');
            }

            loadSong(index) {
                if (index < 0 || index >= this.playlist.length) return;
                
                this.currentSongIndex = index;
                const song = this.playlist[index];
                
                this.audio.src = song.url;
                this.songTitle.textContent = song.name;
                this.songArtist.textContent = 'Local file';
                
                // Update favorite button
                this.favoriteBtn.classList.toggle('active', this.favorites.has(song.id));
                
                this.updatePlaylist();
                
                if (this.isPlaying) {
                    this.audio.play().catch(e => {
                        this.showNotification('Error playing song', 'error');
                    });
                }
            }

            togglePlayPause() {
                if (this.currentSongIndex === -1 && this.playlist.length > 0) {
                    this.loadSong(0);
                }
                
                if (this.currentSongIndex === -1) return;
                
                if (this.isPlaying) {
                    this.audio.pause();
                    this.playPauseBtn.textContent = '▶';
                    this.albumArt.classList.remove('playing');
                    this.stopVisualizer();
                } else {
                    this.audio.play().catch(e => {
                        this.showNotification('Error playing song', 'error');
                        return;
                    });
                    this.playPauseBtn.textContent = '⏸';
                    this.albumArt.classList.add('playing');
                    this.startVisualizer();
                }
                this.isPlaying = !this.isPlaying;
            }

            playPrevious() {
                if (this.playlist.length === 0) return;
                
                if (this.audio.currentTime > 3) {
                    this.audio.currentTime = 0;
                } else {
                    let prevIndex = this.currentSongIndex - 1;
                    if (prevIndex < 0) prevIndex = this.playlist.length - 1;
                    this.loadSong(prevIndex);
                    if (this.isPlaying) this.audio.play();
                }
            }

            playNext() {
                if (this.playlist.length === 0) return;
                
                let nextIndex;
                if (this.isShuffled) {
                    nextIndex = Math.floor(Math.random() * this.playlist.length);
                } else {
                    nextIndex = this.currentSongIndex + 1;
                    if (nextIndex >= this.playlist.length) nextIndex = 0;
                }
                
                this.loadSong(nextIndex);
                if (this.isPlaying) this.audio.play();
            }

            toggleShuffle() {
                this.isShuffled = !this.isShuffled;
                this.shuffleBtn.style.opacity = this.isShuffled ? '1' : '0.5';
                this.shuffleBtn.style.color = this.isShuffled ? 'var(--primary)' : 'var(--text)';
            }

            toggleRepeat() {
                this.repeatMode = (this.repeatMode + 1) % 3;
                const icons = ['🔁', '🔂', '🔁'];
                const titles = ['Repeat Off', 'Repeat One', 'Repeat All'];
                this.repeatBtn.textContent = icons[this.repeatMode];
                this.repeatBtn.title = titles[this.repeatMode];
                this.repeatBtn.style.opacity = this.repeatMode === 0 ? '0.5' : '1';
                this.repeatBtn.style.color = this.repeatMode === 0 ? 'var(--text)' : 'var(--primary)';
            }

            handleSongEnd() {
                if (this.repeatMode === 2) { // Repeat one
                    this.audio.currentTime = 0;
                    this.audio.play();
                } else if (this.repeatMode === 1 || this.currentSongIndex < this.playlist.length - 1) { // Repeat all or not last song
                    this.playNext();
                } else {
                    this.isPlaying = false;
                    this.playPauseBtn.textContent = '▶';
                    this.albumArt.classList.remove('playing');
                    this.stopVisualizer();
                }
            }

            toggleFavorite() {
                if (this.currentSongIndex === -1) return;
                
                const song = this.playlist[this.currentSongIndex];
                if (this.favorites.has(song.id)) {
                    this.favorites.delete(song.id);
                    this.favoriteBtn.classList.remove('active');
                } else {
                    this.favorites.add(song.id);
                    this.favoriteBtn.classList.add('active');
                }
                this.saveToLocalStorage();
            }

            removeSong(index) {
                if (index === this.currentSongIndex) {
                    this.audio.pause();
                    this.isPlaying = false;
                    this.playPauseBtn.textContent = '▶';
                    this.albumArt.classList.remove('playing');
                    this.stopVisualizer();
                    this.currentSongIndex = -1;
                    this.songTitle.textContent = 'No song selected';
                    this.songArtist.textContent = 'Add a song to start playing';
                } else if (index < this.currentSongIndex) {
                    this.currentSongIndex--;
                }
                
                this.playlist.splice(index, 1);
                this.updatePlaylist();
                this.saveToLocalStorage();
                this.showNotification('Song removed from playlist', 'success');
            }

            clearPlaylist() {
                if (this.playlist.length === 0) return;
                
                if (confirm('Are you sure you want to clear the playlist?')) {
                    this.audio.pause();
                    this.isPlaying = false;
                    this.playPauseBtn.textContent = '▶';
                    this.albumArt.classList.remove('playing');
                    this.stopVisualizer();
                    this.playlist = [];
                    this.currentSongIndex = -1;
                    this.songTitle.textContent = 'No song selected';
                    this.songArtist.textContent = 'Add a song to start playing';
                    this.updatePlaylist();
                    this.saveToLocalStorage();
                    this.showNotification('Playlist cleared', 'success');
                }
            }

            updateProgress() {
                const percent = (this.audio.currentTime / this.audio.duration) * 100;
                this.progress.style.width = `${percent}%`;
                this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime);
            }

            updateDuration() {
                this.durationEl.textContent = this.formatTime(this.audio.duration);
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            startVisualizer() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    
                    this.source = this.audioContext.createMediaElementSource(this.audio);
                    this.source.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                }
                
                this.drawVisualizer();
            }

            stopVisualizer() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                // Clear canvas
                this.ctx.fillStyle = 'rgba(0, 0, 0, 1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawVisualizer() {
                this.animationId = requestAnimationFrame(() => this.drawVisualizer());
                
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                this.analyser.getByteFrequencyData(dataArray);
                
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                const barWidth = (this.canvas.width / bufferLength) * 2.5;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * this.canvas.height * 0.8;
                    
                    const gradient = this.ctx.createLinearGradient(0, this.canvas.height - barHeight, 0, this.canvas.height);
                    gradient.addColorStop(0, '#6366f1');
                    gradient.addColorStop(1, '#ec4899');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }

            showNotification(message, type = 'success') {
                const notification = this.notification;
                const icon = notification.querySelector('.notification-icon');
                const text = notification.querySelector('.notification-text');
                
                notification.className = `notification ${type}`;
                icon.textContent = type === 'success' ? '✓' : '✕';
                text.textContent = message;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            saveToLocalStorage() {
                const data = {
                    playlist: this.playlist.map(song => ({
                        id: song.id,
                        name: song.name,
                        url: song.url,
                        duration: song.duration
                    })),
                    favorites: Array.from(this.favorites),
                    volume: this.audio.volume,
                    shuffle: this.isShuffled,
                    repeat: this.repeatMode
                };
                localStorage.setItem('perfectPlayerData', JSON.stringify(data));
            }

            loadFromLocalStorage() {
                const data = localStorage.getItem('perfectPlayerData');
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        this.playlist = parsed.playlist || [];
                        this.favorites = new Set(parsed.favorites || []);
                        this.previousVolume = parsed.volume || 0.7;
                        this.audio.volume = this.previousVolume;
                        this.volumeLevel.style.width = `${this.previousVolume * 100}%`;
                        this.updateVolumeIcon(this.previousVolume);
                        this.isShuffled = parsed.shuffle || false;
                        this.shuffleBtn.style.opacity = this.isShuffled ? '1' : '0.5';
                        this.shuffleBtn.style.color = this.isShuffled ? 'var(--primary)' : 'var(--text)';
                        this.repeatMode = parsed.repeat || 0;
                        this.toggleRepeat();
                        this.toggleRepeat();
                        this.updatePlaylist();
                    } catch (e) {
                        console.error('Error loading data from localStorage:', e);
                    }
                }
            }
        }

        const player = new PerfectMusicPlayer();
    </script>
</body>
</html>
